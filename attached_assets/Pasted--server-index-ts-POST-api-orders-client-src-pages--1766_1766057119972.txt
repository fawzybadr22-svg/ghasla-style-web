افتح الملفات التالية:

server/index.ts أو أي ملف يعرّف مسار POST /api/orders.

client/src/pages/Booking.tsx.

client/src/context/AuthContext.tsx.

في AuthContext.tsx:

تأكد أن معالجة أخطاء Firebase للتسجيل وتسجيل الدخول مميّزة كما يلي:

إذا كان الخطأ auth/email-already-in-use عند registerWithEmail، أعد رسالة واضحة للمستخدم بأن البريد مسجّل مسبقًا واقترح استخدام تسجيل الدخول بدل إنشاء حساب جديد، ولا تحاول إعادة طلب التسجيل مرة أخرى بنفس الإيميل.

إذا كان الخطأ auth/invalid-credential عند loginWithEmail، اعرض رسالة أن البريد أو كلمة المرور غير صحيحة بدل رسالة عامة.

في server/index.ts (أو ملف الراوتر الخاص بالطلبات):

راجع منطق مسار POST /api/orders وحدّد الحقول المطلوبة (مثل servicePackageId, scheduledDate, locationId أو غيرها).

أضف Log واضحًا قبل الرد بـ 400 يطبع جسم الطلب req.body ورسالة توضح أي حقل ناقص أو غير صالح.

عدّل التحقق (validation) بحيث يقبل البيانات التي يرسلها الـ frontend حاليًا، أو حدّث الـ frontend ليطابق ما يحتاجه الـ backend. الهدف أن يصبح طلب حجز مكتمل وصحيح يرجع 200 أو 201 وليس 400 عند تزويد جميع الحقول.

في client/src/pages/Booking.tsx:

تأكد أن دالة handleSubmit تبني جسم الطلب المرسل إلى /api/orders بنفس الحقول والأسماء التي يتوقعها السيرفر بعد الخطوة السابقة.

إذا لم يكن حقل الموقع (location) يُرسل حاليًا، أضف إرسال الموقع في الـ payload، أو تأكد أن السيرفر لا يعتبره حقلًا إجباريًا إذا كان سيُنشأ تلقائيًا.

بعد نجاح الطلب (status 200 أو 201)، أظهر رسالة نجاح الحجز ونظّف النموذج. إذا أعاد السيرفر 400 مع رسالة خطأ في الـ JSON، اعرض هذه الرسالة للمستخدم بدل رسالة عامة.

تأكد أن زر "إضافة الموقع تلقائيًا" يعمل:

افتح المكوّن أو الهُوك المسؤول عن إضافة الموقع (غالبًا في Booking.tsx أو ملف hook في client/src/hooks).

إذا كان يعتمد على الحصول على إحداثيات المتصفح (navigator.geolocation)، أضف معالجة للأذونات (permission denied) ورسالة توجيه للمستخدم.

اربط هذا الزر بحيث يحدّث حقل موقع الحجز في الـ state، ومن ثمّ يُضمَّن في جسم الطلب المرسل إلى /api/orders.

بعد تنفيذ التعديلات:

أعد تشغيل السيرفر والـ client.

نفّذ حجزًا تجريبيًا من الواجهة وتأكد أن:

تسجيل الدخول والتسجيل بالبريد يعملان برسائل خطأ صحيحة.

زر إضافة الموقع يملأ حقل الموقع في النموذج.

طلب POST /api/orders يرجع استجابة ناجحة (ليس 400) عندما تكون كل البيانات مكتملة.