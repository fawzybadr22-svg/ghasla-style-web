1. عنوان عام للمهمة
تحسين نظام الطلبات وخدمات الغسيل ليشمل:

تحديث فوري للأسعار والأوصاف في كل صفحات الموقع.

ضبط الأدوار والصلاحيات (مندوب / مشرف / سوبر أدمن).

إصلاح تتبع الطلبات وظهورها في لوحات جميع الأدوار.

معالجة مشكلة حظر الحسابات.

إدارة سجل العمليات (Activity Log).

إضافة القبول التلقائي للطلبات عند المندوب.

تفعيل تعديل نوع الباقة (Upgrade/Downgrade) لطلب قائم.

2. المتطلبات التفصيلية حسب البنود
2.1 تحديث الأسعار والأوصاف في الموقع (Real‑Time Service Data)
المشكلة

تعديل السعر أو الوصف من لوحة التحكم يُحفظ في الـDB لكن لا يظهر مباشرة في:

الصفحة الرئيسية.

صفحة الخدمة.

صفحة الحجز.

وجود اختلاف بين السعر المعروض (مثلاً 3 د.ك) والسعر الفعلي في الباقة (4–5 د.ك حسب نوع السيارة).

المطلوب

توحيد مصدر بيانات الخدمات

إزالة أي قيم أسعار/أوصاف مكتوبة مباشرة في الواجهة (Hard‑coded) في جميع الصفحات.

جعل كل الصفحات تعتمد على نفس الـEndpoints لقراءة الخدمات، مثل:

GET /api/services لقائمة الخدمات.

GET /api/services/{id} لتفاصيل خدمة/باقة واحدة.

أي مكان يعرض نص "يبدأ من X د.ك" يجب أن يُحسب من جدول service_packages أو services وليس من ثابت في الكود.
​

تفعيل التحديث اللحظي مع الكاش

بعد تنفيذ create_package, update_package, delete_package:

تنفيذ عملية cache invalidation لكل المفاتيح المرتبطة بالخدمات، مثل:

services:list

service:{id}

إذا كان هناك Job/Queue لتحديث الكاش، التأكد من:

عمله بشكل صحيح في البيئة الحيّة.

إضافة Log واضح في حالة الفشل.

في الواجهة الأمامية:

استخدام طلب API واحد للباقة/الخدمة في كل المواقع التي تحتاجها، وعدم حفظ نسخ قديمة في State دون تحديث.

يمكن استخدام WebSockets أو Pub/Sub لتحديث الواجهات المفتوحة عند تغيير الأسعار، كما يُنصح في لوحات البيانات المباشرة.
​

2.2 إصلاح إنشاء حساب المندوب الذي يتحول لمشرف (Roles & Permissions)
المشكلة

عند إنشاء مستخدم بدور "مندوب" من لوحة السوبر، يتم حفظه كـ"مشرف" أو يظهر ضمن المشرفين، فيحصل على صلاحيات أعلى من المطلوب.

المطلوب

مراجعة نموذج/Endpoint إنشاء المستخدم

التأكد أن حقل role أو type يستقبل القيمة الصحيحة القادمة من الـDropdown (مثال: driver أو agent).

منع أي Override للدور من Middleware أو Logic آخر يفرض قيمة admin أو manager تلقائيًا.

تطبيق RBAC واضح

استخدام حزمة مثل spatie/laravel-permission أو بنية مشابهة للأدوار والصلاحيات.
​

تعريف أدوار أساسية:

super_admin

supervisor

driver (مندوب)

(اختياري) customer

ضبط صلاحيات كل دور:

المندوب: عرض الطلبات المسندة له، قبول/رفض، تغيير الحالة ضمن حدود.

المشرف: إدارة الطلبات، الباقات، العملاء ضمن النظام.

السوبر أدمن: إدارة الأدوار والصلاحيات وسجل العمليات والإعدادات العامة.

تعديل الواجهات

القوائم (عملاء / مناديب / مشرفين) يجب أن تُبنى على أساس role من الـDB، لا على مجرد وجود المستخدم في جدول عام.

2.3 تتبع الطلب برقم الطلب + عدم ظهور الطلبات في "Track Your Orders"
المشكلة

صفحة "تتبع طلبك" تُرجع أن الطلب غير موجود مع أن الطلب موجود ومكتمل في لوحة التحكم.

صفحة "Track Your Orders" لا تعرض أي طلبات للعميل رغم وجودها في النظام.

المطلوب

توحيد صيغة رقم الطلب

في الـDashboard يُعرض رقم مثل #dcda5789 بينما في الـDB غالبًا مخزون بدون #.

في API التتبع:

تنظيف المدخل:

إزالة #، المسافات، أو الرموز الزائدة قبل البحث.

البحث يكون في حقل مخصص مثل tracking_code أو public_id، وليس الـID الداخلي فقط.

ربط الطلبات بالمستخدمين

التأكد أن حقل user_id أو ما يعادله في orders مرتبط بحساب العميل الصحيح (نفس الإيميل الظاهر في حساب "حسابي").

تعديل استعلام صفحة "Track Your Orders" ليكون بالشكل التالي (منطقيًا):

SELECT * FROM orders WHERE user_id = auth()->id()

إضافة فلاتر بالحالة عند الحاجة، لكن افتراضيًا يتم عرض جميع الحالات.

صلاحيات عرض الطلبات لكل دور

المندوب: يرى الطلبات التي assigned_driver_id = current_driver_id.

المشرف: يرى جميع طلبات الفرع/النظام حسب التصميم.

السوبر أدمن: يرى كافة الطلبات.

ضبط فلتر الحالة في التتبع

جعل الفلتر الافتراضي في التتبع "كل الحالات" حتى لا تُخفى الطلبات المكتملة أو الملغاة بدون قصد.

2.4 مشكلة “Account is blocked” رغم أن الحساب مفعّل
المشكلة

عند تأكيد الحجز يظهر خطأ "Account is blocked" بينما حالة الحساب Active أو تم فك الحظر من لوحة التحكم.

المطلوب

مراجعة شرط الحظر في منطق الدفع/الطلب

حصر شرط الحظر في حقل واحد واضح مثل:

status = 'blocked' أو is_blocked = 1.

التحقق من عدم استخدام حقول أخرى مثل is_verified أو email_verified_at كمؤشر غير مباشر للحظر.

توحيد عملية إلغاء الحظر

عند فك الحظر من لوحة التحكم يجب تحديث جميع الحقول ذات العلاقة:

is_blocked = 0

status = 'active'

blocked_at = null

تحديث الـSession/Token بعد فك الحظر

في حال استخدام JWT أو تخزين حالة المستخدم في Session:

إعادة إنشاء التوكن أو تحديث Session بعد تغيير حالة الحظر حتى لا يظل الكاش يحمل القيمة القديمة.

2.5 سجل العمليات (Activity Log) – إضافة خاصية التنظيف
المشكلة

لا يوجد خيار من لوحة السوبر أدمن لحذف أو تنظيف سجل العمليات المتراكم.

المطلوب

إضافة زر “تفريغ/تنظيف سجل العمليات”

في لوحة السوبر أدمن فقط.

عند الضغط:

يظهر Modal تأكيد نصه مثل:

"سيتم حذف/أرشفة جميع السجلات حسب الفلتر المحدد، ولا يمكن التراجع عن العملية."

آلية التنفيذ

خيار 1: حذف كامل

تنفيذ أمر DELETE FROM activity_logs أو ما يعادله.

خيار 2 (أفضل): أرشفة

نقل السجلات الأقدم من تاريخ X أو أقدم من N يوم (مثلاً 90 يوم) إلى جدول أرشيف activity_logs_archive ثم حذفها من الجدول الرئيسي، وفق أفضل ممارسات كاش وقواعد البيانات لتجنب تأثير على الأداء.
​

2.6 ظهور الطلبات تلقائيًا في حساب المندوب/المشرف/السوبر أدمن (Real‑Time Orders)
المشكلة

بعد إنشاء طلب جديد لا يظهر في لوحات الأدوار إلا بعد إعادة التحميل يدويًا، أو لا يظهر لبعض الأدوار.

المطلوب

ربط الطلب بالمستلم الصحيح

عند إنشاء الطلب يجب تحديد:

assigned_driver_id للمندوب (إن تم التعيين مباشرة).

أو branch_id لتوزيع الطلبات على مناديب الفرع لاحقًا.

تحديث لحظي للطلبات

استخدام WebSockets / Socket.IO / Laravel Echo (حسب التقنية الحالية) لإرسال حدث new-order وorder-updated إلى:

المندوبين المعنيين.

المشرفين والسوبر أدمن.

في الواجهات يتم الاشتراك في هذه الأحداث لتحديث قوائم الطلبات دون Refresh، كما هو معمول به في لوحات الطلبات المباشرة.
​

إدارة فلاتر العرض

المندوب:

تبويب "طلباتي" (المسندة له).

تبويب اختياري "طلبات متاحة حولي" إن وُجد منطق توزيع.

المشرف والسوبر:

فلاتر للحالة، الفرع، المندوب… مع تحديث مباشر عند تغيير حالة الطلب.

2.7 خاصية القبول التلقائي للطلبات عند المندوب (Auto‑Accept)
المشكلة/الميزة

الحاجة إلى خيار يسمح للمندوب بقبول الطلبات الجديدة تلقائيًا عند تفعيل الميزة، وإيقافها عند الحاجة.

المطلوب

تعديل قاعدة البيانات

إضافة حقل إلى جدول المندوبين drivers مثلاً:

auto_accept_orders من نوع Boolean، القيمة الافتراضية false.

منطق تعيين الطلب

عند وصول طلب جديد:

يبحث النظام عن مناديب في نفس المنطقة/الفرع لديهم auto_accept_orders = true.

إذا وُجد مندوب مناسب:

يتم تعيين الطلب له مباشرة (assigned_driver_id).

يتم تغيير حالة الطلب إلى accepted (مع تحديث التايم لاين).

إذا لم يوجد:

يتم العمل بالوضع الحالي (قبول يدوي).

واجهة المندوب

إضافة Toggle في صفحة حساب المندوب مثل:

"تشغيل القبول التلقائي للطلبات".

عند التغيير يتم استدعاء Endpoint لتحديث حقل auto_accept_orders.

عرض رسالة توضيحية للمندوب بأن تفعيل الخيار سيجعل الطلبات تُقبل تلقائيًا دون تأكيد يدوي.

2.8 تحديث لحظي لكل ما يخص الخدمة (Global Real‑Time Service Sync)
المشكلة/المطلوب

أي تغيير في الخدمة (سعر، وصف، مدة، خيارات…) يجب أن ينعكس فورًا في:

الرئيسية.

صفحة الخدمة.

صفحة الحجز.

تتبع الطلب.

تفاصيل الطلب في لوحات الأدوار.

المطلوب

طبقة API موحدة للخدمات

الاعتماد على Endpoints الخدمة نفسها في جميع الشاشات.

منع تكرار المنطق أو DUPLICATED MODELS في الواجهة.

إلغاء التخزين المحلي القديم

منع الاعتماد على LocalStorage/State قديم بدون تحديث.

بعد أي استدعاء ناجح لتعديل خدمة/باقة، يتم إعادة جلب بيانات الخدمة أو استخدام Event/WebSocket لتحديثها مباشرة.
​

إدارة الكاش بذكاء

استخدام TTL مناسب للبيانات التي تحتاج تحديث مستمر (قصير جدًا أو بدون كاش لبيانات حساسة/لحظية).
​

تطبيق Cache Invalidation عند:

update_service

update_package

حذف أو إضافة خدمة/باقة جديدة.

2.9 تعديل نوع الباقة (Upgrade/Downgrade) لطلب قائم
المطلوب – ملخّص للتنفيذ (كما في رسالتك السابقة):

زر في صفحة تفاصيل الطلب للمشرف/السوبر: تعديل الباقة (Upgrade/Downgrade).

Modal لاختيار الباقة الجديدة + عرض السعر الجديد والفرق المالي + حقل ملاحظات.

Endpoint POST /admin/orders/{order_id}/change-package يقوم بـ:

التحقق من الدور (Supervisor/Super Admin فقط).

التحقق من حالة الطلب.

قراءة الباقة الجديدة من جدول الباقات.

حساب السعر الجديد وتحديث حقول الطلب (package_id, total_amount إلخ).

تسجيل سجل التغيير في جدول order_package_changes مع: الباقة القديمة، الجديدة، السعر القديم والجديد، الفرق، المنفذ، الوقت.

تحديث كل الواجهات (عميل – مندوب – مشرف – تتبع) لتقرأ بيانات الطلب مباشرة من الـDB بحيث يظهر التعديل فورًا.

تسجيل العملية في Activity Log.

3. متطلبات عامة لعدم الإضرار بباقي النظام
العمل على فرع منفصل في الـGit

إنشاء فرع تطوير خاص بهذه التعديلات، ثم دمجه بعد الاختبار.

اختبارات وحدة وتكامل (Unit & Integration Tests)

تغطية منطق:

تغيير الأسعار مع الكاش.

تتبع الطلب.

صلاحيات الأدوار.

القبول التلقائي.

تغيير الباقة.

بيئة Staging قبل الإنتاج

اختبار كل التعديلات على نسخة Staging تحتوي على نسخة من قاعدة البيانات (مع إخفاء بيانات حساسة) قبل النشر على الإنتاج، لضمان عدم كسر أي جزء من السيستم.