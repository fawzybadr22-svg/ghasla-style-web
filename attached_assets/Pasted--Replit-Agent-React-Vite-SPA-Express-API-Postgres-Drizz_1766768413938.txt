أنت Replit Agent. الهدف: تجهيز مشروع React+Vite (SPA) + Express API + Postgres/Drizzle + Firebase Admin للنشر على Vercel فورًا بدون أي تعديل يدوي بعد انتهاءك.

المواصفات النهائية:
- Frontend: يبنى بـ Vite ويخرج إلى dist/public.
- Backend: Express يعمل كـ Vercel Function (export default app) ويستقبل كل /api/* عبر Catch‑all داخل api/.
- SPA routing: أي مسار غير /api/* يرجع /index.html.
- Internal endpoints: تكون تحت /api/internal/*.
- تأكيد نهائي: لا يوجد app.listen() داخل مجلد api/.

نفّذ التعديلات التالية حرفيًا:

1) vercel.json (استبدال كامل)
ضع هذا الملف في جذر المشروع:
{
  "version": 2,
  "framework": "vite",
  "buildCommand": "npm run build:vercel",
  "outputDirectory": "dist/public",
  "rewrites": [
    { "source": "/((?!api/).*)", "destination": "/index.html" }
  ]
}
ملاحظة: لا تضف أي rewrites لـ /api/* ولا /internal/* نهائيًا. [web:19][web:16]

2) Catch‑all للـ API على Vercel
أنشئ الملف: api/[...path].ts
المحتوى:
import app from "./index";
export default app;
هذا يضمن أن كل /api/* تصل لتطبيق Express مع نفس الـ path. [web:73]

3) تعديل api/index.ts لتوحيد internal تحت /api/internal/*
- عدّل limiter:
  app.use("/internal", internalLimiter);
  إلى:
  app.use("/api/internal", internalLimiter);

- عدّل internal routes (3 مسارات):
  "/internal/make-super-admin" -> "/api/internal/make-super-admin"
  "/internal/set-admin"        -> "/api/internal/set-admin"
  "/internal/set-delegate"     -> "/api/internal/set-delegate"

- تأكد أن نهاية الملف تحتوي:
  export default app;
- ممنوع وجود app.listen() داخل أي ملف في مجلد api/. [web:73]

4) تعديل package.json (الأساسي في جذر المشروع)
- أضف سكربت:
  "build:vercel": "vite build"
- أضف engines لتثبيت إصدار Node مناسب:
  "engines": { "node": ">=20.11.0" }
مهم: عدّل package.json الرئيسي فقط (مش package.json داخل functions/). [web:44]

5) اختبارات إلزامية قبل إنهاء المهمة
نفّذ من جذر المشروع:
- npm install
- npm run build:vercel
وتأكد أن الملف موجود:
- dist/public/index.html

6) مخرجات لازم ترسلها في النهاية
- محتوى الملفات النهائية (copy/paste):
  - vercel.json
  - api/[...path].ts
  - المقاطع المعدلة من api/index.ts (سطر limiter + 3 internal routes + export default)
  - مقطع package.json الذي يحوي build:vercel و engines
- شجرة مجلدات مختصرة تثبت وجود: api/[...path].ts و dist/public/index.html
- تأكيد صريح: لا يوجد app.listen() داخل مجلد api/

ابدأ التنفيذ الآن.
