أنت Replit Agent. نفّذ “آخر تعديل نهائي” لتجهيز مشروع React+Vite (SPA) + Express API + Postgres/Drizzle + Firebase Admin للنشر على Vercel بدون أي تعديل يدوي بعده.

المطلوب النهائي:
- Frontend: يبنى بـ Vite ويخرج إلى dist/public.
- Backend: Express كـ Vercel Function (default export) ويستقبل كل /api/* عبر ملف catch‑all.
- Routing: SPA fallback لأي مسار غير /api/* إلى /index.html.
- Internal endpoints: تكون تحت /api/internal/*.
- لا يوجد app.listen() داخل مجلد api/.
- Vercel سيستخدم Build Command و Output Directory من vercel.json.

نفّذ الخطوات التالية حرفيًا:

1) تحقق من vite.config.ts:
- تأكد أن:
  - root = "<projectRoot>/client"
  - build.outDir = "<projectRoot>/dist/public"
- لا تغيّر هذه القيم.

2) أنشئ ملف Catch‑all للـ API:
- أنشئ ملف جديد بالمسار: api/[...path].ts
- محتواه بالضبط:
  --------------------------------
  import app from "./index";
  export default app;
  --------------------------------
(هذا يضمن أن كل /api/* تصل لنفس Express app ويحافظ على المسار) [مهم للتوافق مع Vercel Functions]. [web:35][web:73]

3) عدّل api/index.ts لتوحيد internal تحت /api/internal/*:
- غيّر الـ limiter:
  app.use("/internal", internalLimiter);
  إلى:
  app.use("/api/internal", internalLimiter);

- غيّر مسارات internal الثلاثة:
  "/internal/make-super-admin"  -> "/api/internal/make-super-admin"
  "/internal/set-admin"         -> "/api/internal/set-admin"
  "/internal/set-delegate"      -> "/api/internal/set-delegate"

- تأكد أن نهاية الملف تحتوي:
  export default app;
- تأكد 100% أنه لا يوجد app.listen() في أي ملف داخل api/. [web:73]

4) استبدل vercel.json بالكامل بالنسخة النهائية التالية (بدون rewrites للـ API نهائيًا):
{
  "version": 2,
  "framework": "vite",
  "buildCommand": "npm run build:vercel",
  "outputDirectory": "dist/public",
  "rewrites": [
    { "source": "/((?!api/).*)", "destination": "/index.html" }
  ]
}
- هذا يضمن SPA fallback مع استثناء /api/* من التحويل. [web:19][web:16]

5) عدّل package.json الرئيسي (في جذر المشروع وليس داخل مجلد functions):
- أضف/عدّل scripts بإضافة:
  "build:vercel": "vite build"
- أضف engines لتثبيت Node مناسب (لأن المشروع يستخدم import.meta.dirname):
  "engines": { "node": ">=20.11.0" }
- لا تحذف أو تغيّر scripts الحالية الأخرى (مثل build أو dev).

6) اختبارات إلزامية قبل إنهاء المهمة:
- نفّذ من الجذر:
  npm install
  npm run build:vercel
- تأكد أن الملف التالي موجود:
  dist/public/index.html
- (اختياري محليًا) شغّل أي تشغيل متاح للتأكد أن:
  GET /api/health يعمل
  POST /api/internal/make-super-admin موجود (محمي بـ X-Super-Admin-Secret)

7) سلّم لي المخرجات التالية داخل الرسالة النهائية:
- محتوى الملفات النهائية (copy/paste):
  - vercel.json
  - api/[...path].ts
  - المقاطع المعدلة من api/index.ts (سطر limiter + 3 internal routes + export default)
  - مقطع package.json الذي يحوي scripts+engines
- شجرة مجلدات مختصرة تثبت وجود:
  api/[...path].ts و dist/public/index.html
- تأكيد صريح: لا يوجد app.listen() داخل مجلد api/.

ابدأ التنفيذ الآن.
